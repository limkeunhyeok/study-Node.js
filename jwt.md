# JWT(JSON Web Token)

## 1. 서버 기반 인증 시스템 vs 토큰 기반 인증 시스템

### 1.1 서버 기반 인증 시스템

- 서버 기반 인증 방식은 서버 측에서 사용자들의 정보를 기억해야 한다.
- 사용자들의 정보를 기억하기 위해선 세션을 유지해야 하는데 메모리나 디스크 또는 데이터베이스를 통해 관리한다.
- Stateful 서버: 클라이언트에게서 요청을 받을 때 마다, 클라이언트의 상태를 계속해서 유지하고, 이 정보를 서비스 제공에 이용한다.

#### 문제점

- 세션
    - 사용자가 인증을 할 때, 서버는 이 기록을 서버에 저장해야 하며, 이를 세션이라고 한다.
    - 만약 로그인 중의 사용자가 많아지면 서버가 과부하될 수 있다.
- 확장성
    - 세션을 사용하면 서버를 확장하는것이 어려워진다.
- CORS (Cross-Origin Resource Sharing)
    - 웹 어플리케이션에서 세션을 관리 할 때 자주 사용되는 쿠키는 단일 도메인 및 서브 도메인에서만 작동하도록 설계되어 있으며, 쿠키를 여러 도메인에서 관리하는것은 좀 번거롭다.

### 1.2 토큰 기반 인증 시스템

- 토큰 기반 인증 방식은 인증받은 사용자들에게 토큰을 발급한다.
- 사용자가 서버에 요청을 할 때 헤더에 토큰을 함께 보내도록 하여 유효성 검사를 한다.
- stateless 서버: 시스템에서는 더 이상 유저의 인증 정보를 서버나 세션에 담아두지 않는다. 즉, 상태유지를 하지 않는다.

#### 이점

- 무상태성(Stateless) & 확장성(Scalability)
    - 토큰은 클라이언트 측에 저장되기 때문에 서버는 완전히 Stateless하며, 클라이언트와 서버의 연결고리가 없기 때문에 확장하기에 매우 적합하다.
- 보안성
    - 클라이언트가 서버로 요청을 보낼 때 더 이상 쿠키를 전달하지 않으므로, 쿠키 사용에 의한 취약점이 사라지게 된다.
    - 하지만 토큰 환경의 취약점이 존재할 수도 있다.
- 확장성(Extensibility)
    - Extensibility는 로그인 정보가 사용되는 분야의 확정을 의미한다.
    - 토큰 기반의 인증 시스템에서는 토큰에 선택적인 권한만 부여하여 발급할 수 있으며 OAuth의 경우 Facebook, Google 등과 같은 소셜 계정을 이용하여 다른 웹서비스에서도 로그인을 할 수 있다.
- 여러 플랫폼 및 도메인
    - 토큰을 사용한다면 어떤 디바이스, 어떤 도메인에서도 토큰의 유효성 검사를 진행한 후에 요청을 처리할 수 있다.

## 2. JWT

![image](https://user-images.githubusercontent.com/38815618/112119704-f5672b80-8c00-11eb-8a6e-779b328346e1.png)

> 공식 홈페이지에서 'JSON 웹 토큰은 두 당사자간에 클레임을 안전하게 표현하기위한 개방형 산업 표준  RFC 7519 방법입니다'라고 소개한다.

### 2.1 개념

- JWT는 웹표준(RFC 7519)으로서 JSON 객체를 사용하여 가볍고 자가수용적인(self-contained) 방식으로 정보를 안전성 있게 전달해주는 Claim 기반의 웹 토큰이다.
- 주로 회원 인증이나 정보 전달에 쓰인다.
- Claim
    - 사용자 정보나 데이터 속성 등을 의미한다.
    - Claim 기반 토큰은 이러한 것들을 담은 토큰을 의미한다.

```json
// 예시
{
  "id":"mhlab",
  "role":["admin","hr"],
  "company":"hexlant"
}
```

### 2.2 구조

#### 헤더(Header)

- typ
    - 토큰의 타입을 지정한다.
- alg
    - 해싱 알고리즘을 지정한다.
    - 주로 HMAC SHA256 또는 RSA를 사용하며, 이 알고리즘은 서명(signature)에서 사용한다.

```json
{
    "typ": "JWT",
    "alg": "HS256"
}
```

#### 내용(Payload)

- 토큰의 페이로드에는 토큰에서 사용할 정보의 조각들인 클레임(Claim)이 담겨 있다.
- Key/Value 방식으로 이뤄져있으며(JSON과 유사) 다수의 정보를 넣을 수 있다.
- 이 클레임은 총 세 가지로 나뉜다.(참고: https://self-issued.info/docs/draft-ietf-oauth-json-web-token.html)
    - 등록된(registered) 클레임: 등록된 클레임은 토큰 정보를 표현하기 위해 이미 정해진 데이터 종류이며, 모두 선택적으로 작성 가능하다.
    - 공개(public) 클레임: 공개 클레임은 서로 충돌이 일어나지 않는 이름을 가지고 있어야한다.
    - 비공개(private) 클레임: 비공개 클레임은 실제 사용을 하는 개발자가 지정하는 것으로 서버와 클라이언트가 서로 정의하여 사용하는 클레임을 의미한다.

```json
{
    "sub": "1234567890",
    "name": "John Doe",
    "admin": true
}
```

#### 서명(Signature)

- 서명은 헤더의 인코딩값과, 정보의 인코딩값을 합친후 주어진 비밀키로 해쉬를 하여 생성합니다.

### 2.3 디버거

- JWT 공식 홈페이지에서 JWT 토큰을 검증하고 생성할 수 있다.
- https://jwt.io/
